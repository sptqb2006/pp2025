import curses
import tkinter as tk
from tkinter import ttk, messagebox, simpledialog
from domains import Student, Course


# ============== Curses Input Helper Functions ==============
def curses_get_input(stdscr, prompt, row, col=2):
    """Get string input from user in curses"""
    stdscr.addstr(row, col, prompt)
    stdscr.refresh()
    curses.echo()
    inp = stdscr.getstr(row, col + len(prompt) + 1, 50).decode('utf-8')
    curses.noecho()
    return inp


def curses_get_int_input(stdscr, prompt, row, col=2):
    """Get integer input from user in curses"""
    while True:
        try:
            val = curses_get_input(stdscr, prompt, row, col)
            return int(val)
        except ValueError:
            stdscr.addstr(row + 1, col, "Invalid number! Press any key to try again.")
            stdscr.refresh()
            stdscr.getch()
            stdscr.move(row, col)
            stdscr.clrtoeol()
            stdscr.move(row + 1, col)
            stdscr.clrtoeol()


def curses_get_float_input(stdscr, prompt, row, col=2):
    """Get float input from user in curses"""
    while True:
        try:
            val = curses_get_input(stdscr, prompt, row, col)
            return float(val)
        except ValueError:
            stdscr.addstr(row + 1, col, "Invalid number! Press any key to try again.")
            stdscr.refresh()
            stdscr.getch()
            stdscr.move(row, col)
            stdscr.clrtoeol()
            stdscr.move(row + 1, col)
            stdscr.clrtoeol()


def curses_wait_for_key(stdscr, row, col=2):
    """Wait for user to press any key"""
    stdscr.addstr(row, col, "Press any key to continue...")
    stdscr.refresh()
    stdscr.getch()


# ============== Curses Input Functions ==============
def input_students_curses(stdscr, collection):
    """Input multiple students via curses"""
    stdscr.clear()
    stdscr.addstr(0, 2, "**** Input Students ****", curses.A_BOLD)

    num = curses_get_int_input(stdscr, "Enter number of students: ", 2)

    for i in range(num):
        stdscr.clear()
        stdscr.addstr(0, 2, f"**** Student {i+1}/{num} ****", curses.A_BOLD)

        sid = curses_get_input(stdscr, "Student ID: ", 2)
        name = curses_get_input(stdscr, "Student Name: ", 3)
        dob = curses_get_input(stdscr, "Date of Birth: ", 4)

        student = Student(sid, name, dob)
        collection.add(student)

        stdscr.addstr(6, 2, f"Student '{name}' added!")
        curses_wait_for_key(stdscr, 8)


def input_courses_curses(stdscr, collection):
    """Input multiple courses via curses"""
    stdscr.clear()
    stdscr.addstr(0, 2, "**** Input Courses ****", curses.A_BOLD)

    num = curses_get_int_input(stdscr, "Enter number of courses: ", 2)

    for i in range(num):
        stdscr.clear()
        stdscr.addstr(0, 2, f"**** Course {i+1}/{num} ****", curses.A_BOLD)

        cid = curses_get_input(stdscr, "Course ID: ", 2)
        name = curses_get_input(stdscr, "Course Name: ", 3)
        credits = curses_get_int_input(stdscr, "Credits: ", 4)

        course = Course(cid, name, credits)
        collection.add(course)

        stdscr.addstr(6, 2, f"Course '{name}' added!")
        curses_wait_for_key(stdscr, 8)


def input_marks_for_course_curses(stdscr, students, courses, mark_manager):
    """Input marks for a specific course via curses"""
    stdscr.clear()
    stdscr.addstr(0, 2, "**** Input Marks ****", curses.A_BOLD)

    if not courses.items:
        stdscr.addstr(2, 2, "No courses available!")
        curses_wait_for_key(stdscr, 4)
        return

    if not students.items:
        stdscr.addstr(2, 2, "No students available!")
        curses_wait_for_key(stdscr, 4)
        return

    # Show courses
    stdscr.addstr(2, 2, "Available Courses:")
    row = 3
    for c in courses.items:
        stdscr.addstr(row, 4, f"{c.id} - {c.name}")
        row += 1

    course_id = curses_get_input(stdscr, "Enter Course ID: ", row + 1)

    if courses.find_by_id(course_id) is None:
        stdscr.addstr(row + 3, 2, "Course not found!")
        curses_wait_for_key(stdscr, row + 5)
        return

    # Input marks for each student
    for student in students.items:
        while True:
            stdscr.clear()
            stdscr.addstr(0, 2, f"Course: {course_id}", curses.A_BOLD)
            stdscr.addstr(1, 2, f"Student: {student.name} (ID: {student.id})")

            mark = curses_get_float_input(stdscr, "Enter mark (0-20): ", 3)
            if mark < 0 or mark > 20:
                stdscr.addstr(5, 2, "Error: Mark must be between 0 and 20!")
                stdscr.addstr(6, 2, "Press any key to try again...")
                stdscr.refresh()
                stdscr.getch()
                continue
            break
        mark_manager.input_marks(course_id, student.id, mark)

        stdscr.addstr(5, 2, "Mark saved!")
        stdscr.refresh()
        curses.napms(500)

    stdscr.clear()
    stdscr.addstr(0, 2, "All marks saved! (Rounded down to 1 decimal)", curses.A_BOLD)
    curses_wait_for_key(stdscr, 2)


def get_student_id_input_curses(stdscr, students):
    """Get student ID from user via curses"""
    stdscr.clear()
    stdscr.addstr(0, 2, "**** Select Student ****", curses.A_BOLD)

    if not students.items:
        stdscr.addstr(2, 2, "No students available!")
        curses_wait_for_key(stdscr, 4)
        return None

    # Show students
    stdscr.addstr(2, 2, "Available Students:")
    row = 3
    for s in students.items:
        stdscr.addstr(row, 4, f"{s.id} - {s.name}")
        row += 1

    return curses_get_input(stdscr, "Enter Student ID: ", row + 1)


def get_course_id_input_curses(stdscr, courses):
    """Get course ID from user via curses"""
    stdscr.clear()
    stdscr.addstr(0, 2, "**** Select Course ****", curses.A_BOLD)

    if not courses.items:
        stdscr.addstr(2, 2, "No courses available!")
        curses_wait_for_key(stdscr, 4)
        return None

    # Show courses
    stdscr.addstr(2, 2, "Available Courses:")
    row = 3
    for c in courses.items:
        stdscr.addstr(row, 4, f"{c.id} - {c.name}")
        row += 1

    return curses_get_input(stdscr, "Enter Course ID: ", row + 1)


def input_students(collection):
    """Input multiple students"""
    num_students = int(input("Enter number of students: "))
    collection.input_multiple(Student, num_students)


def input_courses(collection):
    """Input multiple courses"""
    num_courses = int(input("Enter number of courses: "))
    collection.input_multiple(Course, num_courses)


def input_students_gui(collection, root):
    """Input multiple students via GUI"""
    num_students = simpledialog.askinteger("Setup", "Enter number of students:", parent=root, minvalue=1)
    if num_students:
        collection.input_multiple_gui(Student, num_students)


def input_courses_gui(collection, root):
    """Input multiple courses via GUI"""
    num_courses = simpledialog.askinteger("Setup", "Enter number of courses:", parent=root, minvalue=1)
    if num_courses:
        collection.input_multiple_gui(Course, num_courses)


def input_marks_for_course(students, courses, mark_manager):
    """Input marks for a specific course"""
    print("\n**** Input Marks ****")
    courses.list_all("Courses list")
    selected_course = input("Select Course ID to input marks: ")

    if courses.find_by_id(selected_course) is None:
        print("Course not found!")
        return

    for student in students.items:
        mark = float(input(f"Enter mark for student {student.name} (ID: {student.id}): "))
        mark_manager.input_marks(selected_course, student.id, mark)
    print("Marks have been rounded down to 1 decimal place using math.floor()")


def input_marks_for_course_gui(students, courses, mark_manager, root):
    """Input marks for a specific course via GUI"""
    if not courses.items:
        messagebox.showwarning("Warning", "No courses available!")
        return

    dialog = tk.Toplevel(root)
    dialog.title("Input Marks")
    dialog.geometry("400x350")
    dialog.transient(root)
    dialog.grab_set()

    ttk.Label(dialog, text="Select Course:").pack(pady=10)

    course_var = tk.StringVar()
    course_combo = ttk.Combobox(dialog, textvariable=course_var, state="readonly", width=30)
    course_combo['values'] = [f"{c.id} - {c.name}" for c in courses.items]
    if course_combo['values']:
        course_combo.current(0)
    course_combo.pack(pady=5)

    ttk.Label(dialog, text="Enter Marks for Students:").pack(pady=10)

    marks_frame = ttk.Frame(dialog)
    marks_frame.pack(fill='both', expand=True, padx=10)

    mark_entries = {}
    for i, student in enumerate(students.items):
        ttk.Label(marks_frame, text=f"{student.name} ({student.id}):").grid(row=i, column=0, padx=5, pady=3, sticky='e')
        entry = ttk.Entry(marks_frame, width=10)
        entry.grid(row=i, column=1, padx=5, pady=3)
        mark_entries[student.id] = entry

    def submit():
        course_selection = course_var.get()
        if not course_selection:
            messagebox.showerror("Error", "Please select a course!")
            return
        course_id = course_selection.split(" - ")[0]

        for student_id, entry in mark_entries.items():
            try:
                mark = float(entry.get())
                mark_manager.input_marks(course_id, student_id, mark)
            except ValueError:
                messagebox.showerror("Error", f"Invalid mark for student {student_id}!")
                return

        messagebox.showinfo("Success", "Marks saved (rounded down to 1 decimal)")
        dialog.destroy()

    ttk.Button(dialog, text="Submit", command=submit).pack(pady=15)
    dialog.wait_window()


def get_student_id_input(students):
    """Get student ID from user"""
    students.list_all("Student List")
    return input("Enter Student ID to calculate GPA: ")


def get_course_id_input(courses):
    """Get course ID from user"""
    courses.list_all("Courses list")
    return input("Select Course ID to view marks: ")


def get_student_id_input_gui(students, root):
    """Get student ID from user via GUI"""
    return simpledialog.askstring("Select Student", "Enter Student ID:", parent=root)


def get_course_id_input_gui(courses, root):
    """Get course ID from user via GUI"""
    return simpledialog.askstring("Select Course", "Enter Course ID:", parent=root)
